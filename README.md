# Pixiv Booth to freee Automation

[![Release](https://img.shields.io/github/v/release/qryuu/booth-freee-automator-repo?label=最新バージョン)](https://github.com/qryuu/booth-freee-automator-repo/releases/latest)

## 概要

このプロジェクトは、[Pixiv Booth](https://booth.pm/)からダウンロードした売上CSVを[会計freee](https://www.freee.co.jp/)に自動で取引登録するための、サーバーレスアプリケーションです。

手動での煩雑な入力作業をなくし、確定申告などの経理業務を効率化することを目的としています。

### 主な機能

* **新旧CSVフォーマット完全対応:** 2025年10月のBOOTH仕様変更（手数料カラム名の変更）に対応。新旧どちらのフォーマットでも自動判別して処理します。
* **S3トリガー:** 指定のS3バケットに売上CSVをアップロードするだけで、自動的に処理が開始されます。
* **複数商品注文の自動合算:** 1回の注文に複数の商品が含まれている場合でも、売上を正しく合算して1つの取引として登録します。
* **安全な認証:** freee APIのOAuth 2.0リフレッシュトークンに対応しており、安全かつ継続的にAPIを利用できます。認証情報はAWS Secrets Managerで厳重に管理されます。
* **サーバーレス:** AWS Lambda (`Node.js 22.x`ランタイム) をベースにしているため、サーバーの管理が不要で、コスト効率に優れています。

### アーキテクチャ

---

## 🚀 Releases (配布ファイル)

ビルド済みのLambda関数 (`deployment.zip`) は、以下のリリースページからダウンロードできます。非エンジニアの方は、こちらをご利用ください。

➡️ [**v1.2.1 (最新版) をダウンロード**](https://github.com/qryuu/booth-freee-automator-repo/releases/latest)

---

## 📖 セットアップガイド

このプロジェクトは、AWSやAPIの知識レベルに応じて、2つのセットアップガイドを用意しています。

### 👩‍🎨 非エンジニアの方向け

AWSの画面操作だけでセットアップを完了できる、丁寧なガイドです。プログラムのコードを触る必要はありません。

➡️ [**Noteで続きを読む**](https://note.com/qryuu/n/n34ab87ef8c3a)

### 🛠️ エンジニアの方向け

ソースコードのカスタマイズや、より詳細な技術的背景を理解したい方向けのガイドです。

➡️ [**Qiitaで続きを読む**](https://qiita.com/qryuu/items/f63c023668f903956b08)

---

## 💻 開発とコントリビューション

このプロジェクトでは、Git Flowに基づいたブランチ戦略と、AWS CodeBuildによる自動デプロイを採用しています。

* **`main`**: 本番環境 (`booth-freee-automator`) と同期します。安定したリリースバージョンが格納されます。
* **`develop`**: テスト環境 (`booth-freee-automator-test`) と同期します。機能追加やバグ修正はまずこちらにマージされ、検証されます。

### 今回の修正手順 (v1.2.1)

1. `develop`ブランチから`feature/fix-csv-columns`ブランチを作成。
2. `index.js`を修正し、手数料カラムの揺らぎ（`手数料` または `サービス利用料・倉庫発送手数料`）を吸収するロジックを追加。
3. `buildspec.yml`を修正し、ブランチ名（`develop` / `main`）に応じてデプロイ先のLambda関数を自動で振り分けるように設定。
4. PRを経て`main`ブランチにマージし、`v1.2.1`としてリリース。

---

## 使い方

セットアップが完了した後の使い方は非常にシンプルです。

1. **Pixiv Booth**から、月次の売上CSVファイルをダウンロードします。
2. セットアップ時に作成した**S3バケット**に、そのCSVファイルをアップロードします。
3. しばらく待つと、**会計freee**の取引一覧に、CSVの内容が自動で登録されます。

## 更新履歴

* **v1.2.1** (2025-11-24)
  * **【重要】BOOTH売上CSVの仕様変更に対応。**
    * 2025年10月以降、カラム名が「手数料」から「サービス利用料・倉庫発送手数料」に変更されたことに伴い、取り込みロジックを修正しました。
  * **Dev/Prod環境の分離による安全なデプロイフローを確立。**
    * `develop`ブランチへの変更はテスト環境へ、`main`への変更は本番環境へ自動デプロイされるようCI/CDを強化しました。
* **v1.2.0** (2025-10-03)
  * **【重要】複数商品を含む注文の会計ロジックを修正。**
    * 「注文番号」単位で売上を合算し、1つの正確な取引として登録するようロジックを刷新しました。
* **v1.1.1** (2025-10-02)
  * 不正な日付データ（空欄など）を含むCSV行を安全にスキップするエラーハンドリング機能を追加。
* **v1.1.0** (2025-09-06)
  * LambdaランタイムをNode.js 20.xから**Node.js 22.x (LTS)**にアップデート。
* **v1.0.0** (2025-09-03)
  * 初回リリース。

## 注意事項

* このアプリケーションは、CSVのフォーマットやfreee APIの仕様変更によって動作しなくなる可能性があります。
* freeeのリフレッシュトークンは、セキュリティ上の理由から定期的に失効する場合があります。その際は、手順書に従って手動で再取得し、AWS Secrets Managerの値を更新してください。

## ライセンス

このプロジェクトは[MITライセンス](LICENSE)の下で公開されています。
